generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["fixitbh_ac"]
}

// ==================== USER & AUTH ====================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  phone        String?
  avatar       String?
  isActive     Boolean   @default(true) @map("is_active")
  isVerified   Boolean   @default(false) @map("is_verified")
  isSystemUser Boolean   @default(false) @map("is_system_user") // Product admin users (not shown in user list)
  lastLoginAt  DateTime? @map("last_login_at")
  roleId       String?   @map("role_id")
  role         Role?     @relation(fields: [roleId], references: [id])
  createdAt    DateTime  @default(now()) @map("audit_create_date")
  createdById  String?   @map("audit_create_by")
  updatedAt    DateTime  @updatedAt @map("audit_change_date")
  updatedById  String?   @map("audit_change_by")

  // Relations
  employee  Employee?
  customer  Customer?
  auditLogs AuditLog[]

  // AMC Relations
  amcContractsCreated   AmcContract[]        @relation("AmcCreatedBy")
  amcContractsApproved  AmcContract[]        @relation("AmcApprovedBy")
  amcContractsCancelled AmcContract[]        @relation("AmcCancelledBy")
  amcSchedulesCompleted AmcServiceSchedule[] @relation("AmcScheduleCompletedBy")

  // Quote Relations
  quotesCreated   Quote[]         @relation("QuoteCreatedBy")
  quotesSent      Quote[]         @relation("QuoteSentBy")
  quotesApproved  Quote[]         @relation("QuoteApprovedBy")
  quoteActivities QuoteActivity[] @relation("QuoteActivityBy")

  // Receipt Relations
  receiptsCreated Receipt[] @relation("ReceiptCreatedBy")
  receiptsVoided  Receipt[] @relation("ReceiptVoidedBy")

  // Timeline Relations
  timelineActions RequestTimeline[]       @relation("TimelinePerformer")
  commentsCreated ServiceRequestComment[] @relation("CommentCreator")

  // Estimate Relations
  estimatesCreated   Estimate[]         @relation("EstimateCreatedBy")
  estimatesSubmitted Estimate[]         @relation("EstimateSubmittedBy")
  estimatesApproved  Estimate[]         @relation("EstimateApprovedBy")
  estimatesRejected  Estimate[]         @relation("EstimateRejectedBy")
  estimateActivities EstimateActivity[] @relation("EstimateActivityBy")

  @@map("users")
  @@schema("fixitbh_ac")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  users       User[]
  permissions RolePermission[]
  menuItems   RoleMenuPermission[]

  @@map("roles")
  @@schema("fixitbh_ac")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
  @@schema("fixitbh_ac")
}

model RolePermission {
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
  @@schema("fixitbh_ac")
}

// Menu items that can be assigned to roles
model MenuItem {
  id        String  @id @default(cuid())
  key       String  @unique // e.g., "dashboard", "requests", "customers"
  name      String // Display name
  nameAr    String? @map("name_ar")
  icon      String? // Icon name
  href      String? // Route path (optional for parent menus)
  sortOrder Int     @default(0) @map("sort_order")
  isActive  Boolean @default(true) @map("is_active")

  // Hierarchical structure
  parentId String?    @map("parent_id")
  parent   MenuItem?  @relation("MenuHierarchy", fields: [parentId], references: [id])
  children MenuItem[] @relation("MenuHierarchy")

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  roleMenus RoleMenuPermission[]

  @@map("menu_items")
  @@schema("fixitbh_ac")
}

// Role-Menu junction table
model RoleMenuPermission {
  roleId      String   @map("role_id")
  menuItemId  String   @map("menu_item_id")
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@id([roleId, menuItemId])
  @@map("role_menu_permissions")
  @@schema("fixitbh_ac")
}

// ==================== ORGANIZATION ====================

model Company {
  id          String   @id @default(cuid())
  name        String
  nameAr      String?  @map("name_ar")
  logo        String?
  email       String?
  phone       String?
  fax         String?
  website     String?
  address     String?
  plusCode    String?  @map("plus_code")
  isActive    Boolean  @default(true) @map("is_active")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  divisions Division[]
  employees Employee[]

  @@map("companies")
  @@schema("fixitbh_ac")
}

model Division {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  code        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  departments Department[]
  employees   Employee[]

  @@map("divisions")
  @@schema("fixitbh_ac")
}

model Department {
  id          String   @id @default(cuid())
  divisionId  String   @map("division_id")
  division    Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  code        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  sections  Section[]
  employees Employee[]

  @@map("departments")
  @@schema("fixitbh_ac")
}

model Section {
  id           String     @id @default(cuid())
  departmentId String     @map("department_id")
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  name         String
  nameAr       String?    @map("name_ar")
  code         String?
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("audit_create_date")
  createdById  String?    @map("audit_create_by")
  updatedAt    DateTime   @updatedAt @map("audit_change_date")
  updatedById  String?    @map("audit_change_by")

  // Relations
  employees Employee[]

  @@map("sections")
  @@schema("fixitbh_ac")
}

// ==================== EMPLOYEE ====================

model Employee {
  id              String      @id @default(cuid())
  userId          String?     @unique @map("user_id")
  user            User?       @relation(fields: [userId], references: [id])
  employeeNo      String      @unique @map("employee_no")
  firstName       String      @map("first_name")
  lastName        String      @map("last_name")
  firstNameAr     String?     @map("first_name_ar")
  lastNameAr      String?     @map("last_name_ar")
  email           String      @unique
  phone           String?
  nationalId      String?     @map("national_id")
  dateOfBirth     DateTime?   @map("date_of_birth")
  hireDate        DateTime?   @map("hire_date")
  jobTitleId      String?     @map("job_title_id")
  jobTitle        JobTitle?   @relation(fields: [jobTitleId], references: [id])
  companyId       String?     @map("company_id")
  company         Company?    @relation(fields: [companyId], references: [id])
  divisionId      String?     @map("division_id")
  division        Division?   @relation(fields: [divisionId], references: [id])
  departmentId    String?     @map("department_id")
  department      Department? @relation(fields: [departmentId], references: [id])
  sectionId       String?     @map("section_id")
  section         Section?    @relation(fields: [sectionId], references: [id])
  managerId       String?     @map("manager_id")
  manager         Employee?   @relation("EmployeeManager", fields: [managerId], references: [id])
  subordinates    Employee[]  @relation("EmployeeManager")
  hasSystemAccess Boolean     @default(false) @map("has_system_access")
  isActive        Boolean     @default(true) @map("is_active")
  lastLatitude    Float?      @map("last_latitude")
  lastLongitude   Float?      @map("last_longitude")
  lastLocationAt  DateTime?   @map("last_location_at")
  createdAt       DateTime    @default(now()) @map("audit_create_date")
  createdById     String?     @map("audit_create_by")
  updatedAt       DateTime    @updatedAt @map("audit_change_date")
  updatedById     String?     @map("audit_change_by")

  // Relations
  zoneAssignments     EmployeeZone[]
  serviceRequests     ServiceRequest[] @relation("AssignedEmployee")
  scheduleAssignments ScheduleTeam[]
  zoneHead            Zone[]           @relation("ZoneHead")
  zoneSecondaryHead   Zone[]           @relation("ZoneSecondaryHead")
  leaveBalances       LeaveBalance[]
  leaveRequests       LeaveRequest[]   @relation("LeaveRequests")
  leaveApprovals      LeaveRequest[]   @relation("LeaveApprover")
  leaveCoverages      LeaveRequest[]   @relation("LeaveCoverage")

  // Site Visit Relations
  siteVisits SiteVisit[] @relation("SiteVisitAssignee")

  // Work Order Relations
  workOrdersCreated   WorkOrder[]          @relation("WorkOrderCreatedBy")
  workOrderTeams      WorkOrderTeam[]
  workOrderLabor      WorkOrderLabor[]
  workOrderChecklists WorkOrderChecklist[]
  workOrderPhotos     WorkOrderPhoto[]
  workOrderActivities WorkOrderActivity[]

  // Notification Relations
  notifications Notification[]

  @@map("employees")
  @@schema("fixitbh_ac")
}

model JobTitle {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  employees Employee[]

  @@map("job_titles")
  @@schema("fixitbh_ac")
}

// ==================== GEOGRAPHIC ====================

model Country {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  code        String   @unique
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  states State[]

  @@map("countries")
  @@schema("fixitbh_ac")
}

model State {
  id          String   @id @default(cuid())
  countryId   String   @map("country_id")
  country     Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  code        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  districts District[]

  @@unique([countryId, name])
  @@map("states")
  @@schema("fixitbh_ac")
}

model District {
  id          String   @id @default(cuid())
  stateId     String   @map("state_id")
  state       State    @relation(fields: [stateId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  code        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  governorates Governorate[]

  @@unique([stateId, name])
  @@map("districts")
  @@schema("fixitbh_ac")
}

model Governorate {
  id          String   @id @default(cuid())
  districtId  String   @map("district_id")
  district    District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  name        String
  nameAr      String?  @map("name_ar")
  code        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  zones Zone[]

  @@unique([districtId, name])
  @@map("governorates")
  @@schema("fixitbh_ac")
}

model Zone {
  id              String      @id @default(cuid())
  governorateId   String      @map("governorate_id")
  governorate     Governorate @relation(fields: [governorateId], references: [id], onDelete: Cascade)
  name            String
  nameAr          String?     @map("name_ar")
  code            String?     @unique
  headId          String?     @map("head_id")
  head            Employee?   @relation("ZoneHead", fields: [headId], references: [id])
  secondaryHeadId String?     @map("secondary_head_id")
  secondaryHead   Employee?   @relation("ZoneSecondaryHead", fields: [secondaryHeadId], references: [id])
  isActive        Boolean     @default(true) @map("is_active")
  createdAt       DateTime    @default(now()) @map("audit_create_date")
  createdById     String?     @map("audit_create_by")
  updatedAt       DateTime    @updatedAt @map("audit_change_date")
  updatedById     String?     @map("audit_change_by")

  // Relations
  employees       EmployeeZone[]
  blocks          Block[]
  buildings       Building[]
  serviceRequests ServiceRequest[]

  @@unique([governorateId, name])
  @@map("zones")
  @@schema("fixitbh_ac")
}

model Block {
  id          String   @id @default(cuid())
  zoneId      String   @map("zone_id")
  zone        Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  blockNo     String   @map("block_no")
  name        String?
  nameAr      String?  @map("name_ar")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  roads     Road[]
  buildings Building[]

  @@unique([zoneId, blockNo])
  @@map("blocks")
  @@schema("fixitbh_ac")
}

model Road {
  id          String   @id @default(cuid())
  blockId     String   @map("block_id")
  block       Block    @relation(fields: [blockId], references: [id], onDelete: Cascade)
  roadNo      String   @map("road_no")
  name        String?
  nameAr      String?  @map("name_ar")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  buildings Building[]

  @@unique([blockId, roadNo])
  @@map("roads")
  @@schema("fixitbh_ac")
}

model EmployeeZone {
  employeeId  String   @map("employee_id")
  zoneId      String   @map("zone_id")
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  zone        Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  role        ZoneRole @default(HELPER) @map("zone_role")
  isPrimary   Boolean  @default(false) @map("is_primary")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@id([employeeId, zoneId])
  @@map("employee_zones")
  @@schema("fixitbh_ac")
}

// ==================== LEAVE MANAGEMENT ====================

model LeaveType {
  id                 String   @id @default(cuid())
  name               String   @unique // Annual, Sick, Emergency, Maternity, Paternity, etc.
  nameAr             String?  @map("name_ar")
  description        String?
  defaultDays        Int      @default(0) @map("default_days") // Default annual allocation
  isPaid             Boolean  @default(true) @map("is_paid")
  requiresApproval   Boolean  @default(true) @map("requires_approval")
  maxConsecutiveDays Int?     @map("max_consecutive_days")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("audit_create_date")
  createdById        String?  @map("audit_create_by")
  updatedAt          DateTime @updatedAt @map("audit_change_date")
  updatedById        String?  @map("audit_change_by")

  // Relations
  balances LeaveBalance[]
  requests LeaveRequest[]

  @@map("leave_types")
  @@schema("fixitbh_ac")
}

model LeaveBalance {
  id            String    @id @default(cuid())
  employeeId    String    @map("employee_id")
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId   String    @map("leave_type_id")
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id])
  year          Int // Year for balance (e.g., 2025)
  totalDays     Float     @map("total_days") // Total allocated days
  usedDays      Float     @default(0) @map("used_days") // Days already used
  pendingDays   Float     @default(0) @map("pending_days") // Days in pending requests
  carryOverDays Float     @default(0) @map("carry_over_days") // Carried from previous year
  createdAt     DateTime  @default(now()) @map("audit_create_date")
  createdById   String?   @map("audit_create_by")
  updatedAt     DateTime  @updatedAt @map("audit_change_date")
  updatedById   String?   @map("audit_change_by")

  @@unique([employeeId, leaveTypeId, year])
  @@map("leave_balances")
  @@schema("fixitbh_ac")
}

model LeaveRequest {
  id                 String      @id @default(cuid())
  employeeId         String      @map("employee_id")
  employee           Employee    @relation("LeaveRequests", fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId        String      @map("leave_type_id")
  leaveType          LeaveType   @relation(fields: [leaveTypeId], references: [id])
  startDate          DateTime    @map("start_date")
  endDate            DateTime    @map("end_date")
  totalDays          Float       @map("total_days")
  reason             String?
  status             LeaveStatus @default(PENDING)
  approverId         String?     @map("approver_id")
  approver           Employee?   @relation("LeaveApprover", fields: [approverId], references: [id])
  approvedAt         DateTime?   @map("approved_at")
  rejectionReason    String?     @map("rejection_reason")
  coveringEmployeeId String?     @map("covering_employee_id") // Who covers during leave
  coveringEmployee   Employee?   @relation("LeaveCoverage", fields: [coveringEmployeeId], references: [id])
  createdAt          DateTime    @default(now()) @map("audit_create_date")
  createdById        String?     @map("audit_create_by")
  updatedAt          DateTime    @updatedAt @map("audit_change_date")
  updatedById        String?     @map("audit_change_by")

  @@map("leave_requests")
  @@schema("fixitbh_ac")
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED

  @@schema("fixitbh_ac")
}

// ==================== CUSTOMER ====================

model Customer {
  id           String       @id @default(cuid())
  userId       String?      @unique @map("user_id")
  user         User?        @relation(fields: [userId], references: [id])
  customerNo   String       @unique @map("customer_no")
  customerType CustomerType @default(INDIVIDUAL) @map("customer_type")
  firstName    String?      @map("first_name")
  lastName     String?      @map("last_name")
  firstNameAr  String?      @map("first_name_ar")
  lastNameAr   String?      @map("last_name_ar")
  orgName      String?      @map("org_name")
  orgNameAr    String?      @map("org_name_ar")
  email        String?      @unique
  phone        String?
  altPhone     String?      @map("alt_phone")
  nationalId   String?      @map("national_id")
  isActive     Boolean      @default(true) @map("is_active")
  isVerified   Boolean      @default(false) @map("is_verified")
  createdAt    DateTime     @default(now()) @map("audit_create_date")
  createdById  String?      @map("audit_create_by")
  updatedAt    DateTime     @updatedAt @map("audit_change_date")
  updatedById  String?      @map("audit_change_by")

  // Relations
  properties      CustomerProperty[]
  units           CustomerUnit[]
  serviceRequests ServiceRequest[]
  invoices        Invoice[]
  amcContracts    AmcContract[]
  quotes          Quote[]
  receipts        Receipt[]

  // Work Order Relations
  workOrders    WorkOrder[]
  reviews       CustomerReview[]
  notifications Notification[]
  memberships   CustomerMembership[]

  @@map("customers")
  @@schema("fixitbh_ac")
}

enum CustomerType {
  INDIVIDUAL
  ORGANIZATION

  @@schema("fixitbh_ac")
}

enum ZoneRole {
  PRIMARY_HEAD // Primary Zone Head
  SECONDARY_HEAD // Backup Zone Head (covers when primary is on leave)
  TECHNICIAN // Zone Technician
  HELPER // Zone Helper

  @@schema("fixitbh_ac")
}

// ==================== BUILDING & PROPERTY ====================

model Building {
  id             String        @id @default(cuid())
  buildingNumber String        @unique @map("building_number") // Building/house number entered by user (e.g., "123")
  roadNumber     String        @map("road_number") // Road number (e.g., "4567")
  blockNumber    String        @map("block_number") // Block number (e.g., "345")
  name           String? // Building name (optional - not all buildings have names)
  nameAr         String?       @map("name_ar")
  typeId         String?       @map("type_id")
  type           BuildingType? @relation(fields: [typeId], references: [id])
  blockId        String?       @map("block_id")
  block          Block?        @relation(fields: [blockId], references: [id])
  roadId         String?       @map("road_id")
  road           Road?         @relation(fields: [roadId], references: [id])
  zoneId         String?       @map("zone_id")
  zone           Zone?         @relation(fields: [zoneId], references: [id])
  totalFloors    Int           @default(1) @map("total_floors")
  totalUnits     Int           @default(0) @map("total_units")
  yearBuilt      Int?          @map("year_built")
  latitude       Float?
  longitude      Float?
  googlePlaceId  String?       @map("google_place_id")
  googleMapId    String?       @map("google_map_id")
  landmark       String?
  landmarkAr     String?       @map("landmark_ar")
  address        String? // Full formatted address
  addressAr      String?       @map("address_ar")
  qrCode         String?       @map("qr_code")
  isActive       Boolean       @default(true) @map("is_active")
  createdAt      DateTime      @default(now()) @map("audit_create_date")
  createdById    String?       @map("audit_create_by")
  updatedAt      DateTime      @updatedAt @map("audit_change_date")
  updatedById    String?       @map("audit_change_by")

  // Relations
  units      Unit[]
  assets     Asset[]    @relation("BuildingAssets")
  facilities Facility[]

  @@map("buildings")
  @@schema("fixitbh_ac")
}

model BuildingType {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  description String?
  icon        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  buildings Building[]

  @@map("building_types")
  @@schema("fixitbh_ac")
}

model Unit {
  id          String     @id @default(cuid())
  unitNo      String     @unique @map("unit_no")
  buildingId  String     @map("building_id")
  building    Building   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  typeId      String?    @map("type_id")
  type        UnitType?  @relation(fields: [typeId], references: [id])
  flatNumber  String?    @map("flat_number")
  unitSuffix  String?    @map("unit_suffix") // Like A, B in 11A, 11B
  floor       Int?
  bedrooms    Int?
  bathrooms   Int?
  areaSqm     Float?     @map("area_sqm")
  isFurnished Boolean    @default(false) @map("is_furnished")
  monthlyRent Decimal?   @map("monthly_rent") @db.Decimal(10, 2)
  status      UnitStatus @default(VACANT)
  qrCode      String?    @map("qr_code")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("audit_create_date")
  createdById String?    @map("audit_create_by")
  updatedAt   DateTime   @updatedAt @map("audit_change_date")
  updatedById String?    @map("audit_change_by")

  // Relations
  customers             CustomerUnit[]
  rooms                 Room[]
  assets                Asset[]
  serviceRequests       ServiceRequest[]
  amcContractProperties AmcContractProperty[]
  amcServiceSchedules   AmcServiceSchedule[]
  quotes                Quote[]

  @@unique([buildingId, flatNumber, unitSuffix])
  @@map("units")
  @@schema("fixitbh_ac")
}

model UnitType {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  description String?
  icon        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  units Unit[]

  @@map("unit_types")
  @@schema("fixitbh_ac")
}

enum UnitStatus {
  VACANT
  OCCUPIED
  MAINTENANCE
  RESERVED

  @@schema("fixitbh_ac")
}

// Legacy Property model - keeping for backward compatibility with older data
model Property {
  id          String       @id @default(cuid())
  propertyNo  String       @unique @map("property_no")
  name        String
  nameAr      String?      @map("name_ar")
  typeId      String       @map("type_id")
  type        PropertyType @relation(fields: [typeId], references: [id])
  zoneId      String?      @map("zone_id")
  address     String?
  addressAr   String?      @map("address_ar")
  building    String?
  floor       String?
  unit        String?
  area        String?
  landmark    String?
  latitude    Float?
  longitude   Float?
  qrCode      String?      @map("qr_code")
  isActive    Boolean      @default(false) @map("is_active") // Legacy records disabled by default
  createdAt   DateTime     @default(now()) @map("audit_create_date")
  createdById String?      @map("audit_create_by")
  updatedAt   DateTime     @updatedAt @map("audit_change_date")
  updatedById String?      @map("audit_change_by")

  // Relations
  customers             CustomerProperty[]
  serviceRequests       ServiceRequest[]
  amcContractProperties AmcContractProperty[]
  amcServiceSchedules   AmcServiceSchedule[]
  quotes                Quote[]

  @@map("properties")
  @@schema("fixitbh_ac")
}

model PropertyType {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  description String?
  level       Int      @default(1)
  parentId    String?  @map("parent_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Self-referential relation for hierarchy
  parent   PropertyType?  @relation("PropertyTypeHierarchy", fields: [parentId], references: [id])
  children PropertyType[] @relation("PropertyTypeHierarchy")

  // Relations
  properties Property[]

  @@map("property_types")
  @@schema("fixitbh_ac")
}

model CustomerProperty {
  customerId    String        @map("customer_id")
  propertyId    String        @map("property_id")
  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  property      Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ownershipType OwnershipType @default(OWNER) @map("ownership_type")
  isPrimary     Boolean       @default(false) @map("is_primary")
  startDate     DateTime?     @map("start_date")
  endDate       DateTime?     @map("end_date")
  createdAt     DateTime      @default(now()) @map("audit_create_date")
  createdById   String?       @map("audit_create_by")

  @@id([customerId, propertyId])
  @@map("customer_properties")
  @@schema("fixitbh_ac")
}

enum OwnershipType {
  OWNER
  TENANT

  @@schema("fixitbh_ac")
}

model CustomerUnit {
  customerId    String        @map("customer_id")
  unitId        String        @map("unit_id")
  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  unit          Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  ownershipType OwnershipType @default(TENANT) @map("ownership_type")
  isPrimary     Boolean       @default(false) @map("is_primary")
  startDate     DateTime?     @map("start_date")
  endDate       DateTime?     @map("end_date")
  monthlyRent   Decimal?      @map("monthly_rent") @db.Decimal(10, 2)
  createdAt     DateTime      @default(now()) @map("audit_create_date")
  createdById   String?       @map("audit_create_by")

  @@id([customerId, unitId])
  @@map("customer_units")
  @@schema("fixitbh_ac")
}

model Room {
  id                  String    @id @default(cuid())
  unitId              String    @map("unit_id")
  unit                Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  typeId              String?   @map("type_id")
  type                RoomType? @relation(fields: [typeId], references: [id])
  name                String
  nameAr              String?   @map("name_ar")
  floor               String?
  hasAttachedBathroom Boolean   @default(false) @map("has_attached_bathroom")
  areaSqm             Float?    @map("area_sqm")
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("audit_create_date")
  createdById         String?   @map("audit_create_by")
  updatedAt           DateTime  @updatedAt @map("audit_change_date")
  updatedById         String?   @map("audit_change_by")

  // Relations
  assets Asset[]

  @@map("rooms")
  @@schema("fixitbh_ac")
}

model RoomType {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  category    String? // RESIDENTIAL, COMMON_FACILITY
  icon        String?
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  rooms Room[]

  @@map("room_types")
  @@schema("fixitbh_ac")
}

// ==================== COMMON FACILITIES (for compounds/villas) ====================

model Facility {
  id             String       @id @default(cuid())
  facilityNo     String       @unique @map("facility_no")
  buildingId     String?      @map("building_id")
  building       Building?    @relation(fields: [buildingId], references: [id])
  typeId         String       @map("type_id")
  type           FacilityType @relation(fields: [typeId], references: [id])
  name           String
  nameAr         String?      @map("name_ar")
  location       String? // e.g., "Ground Floor", "Rooftop", "Outdoor"
  capacity       Int? // max occupancy for gyms, theaters, etc.
  operatingHours String?      @map("operating_hours") // e.g., "6AM-10PM"
  rules          String? // usage rules
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("audit_create_date")
  createdById    String?      @map("audit_create_by")
  updatedAt      DateTime     @updatedAt @map("audit_change_date")
  updatedById    String?      @map("audit_change_by")

  // Relations
  assets Asset[] @relation("FacilityAssets")

  @@map("facilities")
  @@schema("fixitbh_ac")
}

model FacilityType {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  icon        String?
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  facilities Facility[]

  @@map("facility_types")
  @@schema("fixitbh_ac")
}

// ==================== ASSET ====================

model Asset {
  id                String         @id @default(cuid())
  assetNo           String         @unique @map("asset_no")
  // Location - asset can be at building level, unit level, room level, or facility level
  buildingId        String?        @map("building_id")
  building          Building?      @relation("BuildingAssets", fields: [buildingId], references: [id])
  unitId            String?        @map("unit_id")
  unit              Unit?          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  roomId            String?        @map("room_id")
  room              Room?          @relation(fields: [roomId], references: [id])
  facilityId        String?        @map("facility_id")
  facility          Facility?      @relation("FacilityAssets", fields: [facilityId], references: [id])
  // Asset details
  typeId            String         @map("type_id")
  type              AssetType      @relation(fields: [typeId], references: [id])
  name              String? // e.g., "Living Room AC", "Main Entrance CCTV"
  nameAr            String?        @map("name_ar")
  brand             String? // e.g., "Daikin", "Hikvision"
  model             String? // e.g., "FTKF35TV16U"
  serialNumber      String?        @map("serial_number")
  capacity          String? // e.g., "1.5 Ton", "4MP"
  specifications    Json? // Additional specs as JSON
  // Financial & Dates
  purchasePrice     Decimal?       @map("purchase_price") @db.Decimal(10, 2)
  purchaseDate      DateTime?      @map("purchase_date")
  installDate       DateTime?      @map("install_date")
  warrantyEndDate   DateTime?      @map("warranty_end_date")
  amcEndDate        DateTime?      @map("amc_end_date") // Annual Maintenance Contract end
  expectedLifeYears Int?           @map("expected_life_years")
  // Status tracking
  status            AssetStatus    @default(ACTIVE)
  condition         AssetCondition @default(GOOD)
  lastServiceDate   DateTime?      @map("last_service_date")
  nextServiceDue    DateTime?      @map("next_service_due")
  // Replacement tracking
  replacedById      String?        @map("replaced_by_id")
  replacedBy        Asset?         @relation("AssetReplacement", fields: [replacedById], references: [id])
  replaces          Asset[]        @relation("AssetReplacement")
  replacedAt        DateTime?      @map("replaced_at")
  replacementReason String?        @map("replacement_reason")
  // Totals (calculated/cached for performance)
  totalServiceCost  Decimal?       @map("total_service_cost") @db.Decimal(10, 2)
  serviceCount      Int            @default(0) @map("service_count")
  // Standard fields
  qrCode            String?        @map("qr_code")
  notes             String?
  isActive          Boolean        @default(true) @map("is_active")
  createdAt         DateTime       @default(now()) @map("audit_create_date")
  createdById       String?        @map("audit_create_by")
  updatedAt         DateTime       @updatedAt @map("audit_change_date")
  updatedById       String?        @map("audit_change_by")

  // Relations
  serviceRequests ServiceRequest[]
  serviceHistory  AssetServiceHistory[]
  documents       AssetDocument[]

  @@map("assets")
  @@schema("fixitbh_ac")
}

enum AssetStatus {
  ACTIVE // Currently in use
  INACTIVE // Not in use but not disposed
  MAINTENANCE // Under repair/maintenance
  REPLACED // Replaced by another asset
  DISPOSED // Removed/disposed

  @@schema("fixitbh_ac")
}

enum AssetCondition {
  EXCELLENT // New or like-new condition
  GOOD // Working well with minor wear
  FAIR // Functioning but showing age
  POOR // Needs attention/repair soon
  CRITICAL // Urgent repair/replacement needed

  @@schema("fixitbh_ac")
}

model AssetType {
  id                         String        @id @default(cuid())
  name                       String        @unique
  nameAr                     String?       @map("name_ar")
  category                   AssetCategory @default(GENERAL)
  icon                       String?
  description                String?
  // Default maintenance schedule
  defaultServiceIntervalDays Int?          @map("default_service_interval_days")
  defaultLifeYears           Int?          @map("default_life_years")
  isActive                   Boolean       @default(true) @map("is_active")
  createdAt                  DateTime      @default(now()) @map("audit_create_date")
  createdById                String?       @map("audit_create_by")
  updatedAt                  DateTime      @updatedAt @map("audit_change_date")
  updatedById                String?       @map("audit_change_by")

  // Relations
  assets Asset[]

  @@map("asset_types")
  @@schema("fixitbh_ac")
}

enum AssetCategory {
  HVAC // AC, heating, ventilation
  ELECTRICAL // Wiring, panels, generators
  PLUMBING // Water heaters, pumps, pipes
  FIRE_SAFETY // Fire extinguishers, alarms, sprinklers
  SECURITY // CCTV, access control, alarms
  ELEVATOR // Lifts, escalators
  APPLIANCES // Kitchen appliances, washing machines
  FURNITURE // Beds, sofas, tables
  ENTERTAINMENT // TV, sound systems, projectors
  POOL_EQUIPMENT // Pumps, filters, heaters
  GYM_EQUIPMENT // Treadmills, weights, machines
  CLEANING // Vacuum cleaners, pressure washers
  LANDSCAPING // Irrigation, garden equipment
  GENERAL // Other/miscellaneous

  @@schema("fixitbh_ac")
}

// Service history tracking - persists across tenant changes
model AssetServiceHistory {
  id                  String          @id @default(cuid())
  assetId             String          @map("asset_id")
  asset               Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  serviceType         ServiceType     @default(REPAIR) @map("service_type")
  // Service details
  description         String
  performedBy         String?         @map("performed_by") // Technician/company name
  performedAt         DateTime        @default(now()) @map("performed_at")
  // Cost tracking
  laborCost           Decimal?        @map("labor_cost") @db.Decimal(10, 2)
  partsCost           Decimal?        @map("parts_cost") @db.Decimal(10, 2)
  totalCost           Decimal?        @map("total_cost") @db.Decimal(10, 2)
  // Parts used
  partsUsed           Json?           @map("parts_used") // [{name, qty, cost}]
  // Condition before/after
  conditionBefore     AssetCondition? @map("condition_before")
  conditionAfter      AssetCondition? @map("condition_after")
  // Warranty/AMC info
  isCoveredByWarranty Boolean         @default(false) @map("is_covered_by_warranty")
  isCoveredByAmc      Boolean         @default(false) @map("is_covered_by_amc")
  // Reference
  serviceRequestId    String?         @map("service_request_id")
  invoiceNumber       String?         @map("invoice_number")
  notes               String?
  createdAt           DateTime        @default(now()) @map("audit_create_date")
  createdById         String?         @map("audit_create_by")
  updatedAt           DateTime        @updatedAt @map("audit_change_date")
  updatedById         String?         @map("audit_change_by")

  @@map("asset_service_history")
  @@schema("fixitbh_ac")
}

enum ServiceType {
  INSTALLATION // Initial setup
  REPAIR // Fix a problem
  MAINTENANCE // Scheduled maintenance
  INSPECTION // Check/assessment
  CLEANING // Deep cleaning
  REPLACEMENT // Part replacement (not full asset)
  UPGRADE // Enhancement/improvement

  @@schema("fixitbh_ac")
}

// Documents associated with assets (warranty cards, insurance, manuals)
model AssetDocument {
  id             String            @id @default(cuid())
  assetId        String            @map("asset_id")
  asset          Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  documentType   AssetDocumentType @map("document_type")
  name           String
  fileName       String            @map("file_name")
  fileType       String            @map("file_type")
  fileSize       Int               @map("file_size")
  filePath       String            @map("file_path")
  // For warranty/insurance docs
  issueDate      DateTime?         @map("issue_date")
  expiryDate     DateTime?         @map("expiry_date")
  provider       String? // Insurance company, warranty provider
  policyNumber   String?           @map("policy_number")
  coverageAmount Decimal?          @map("coverage_amount") @db.Decimal(10, 2)
  notes          String?
  uploadedBy     String?           @map("uploaded_by")
  createdAt      DateTime          @default(now()) @map("audit_create_date")
  createdById    String?           @map("audit_create_by")
  updatedAt      DateTime          @updatedAt @map("audit_change_date")
  updatedById    String?           @map("audit_change_by")

  @@map("asset_documents")
  @@schema("fixitbh_ac")
}

enum AssetDocumentType {
  WARRANTY_CARD
  INSURANCE_POLICY
  PURCHASE_INVOICE
  INSTALLATION_CERT
  AMC_CONTRACT
  USER_MANUAL
  SERVICE_REPORT
  INSPECTION_CERT
  OTHER

  @@schema("fixitbh_ac")
}

// ==================== SERVICE REQUEST ====================

model ServiceRequest {
  id              String        @id @default(cuid())
  requestNo       String        @unique @map("request_no")
  customerId      String        @map("customer_id")
  customer        Customer      @relation(fields: [customerId], references: [id])
  propertyId      String?       @map("property_id")
  property        Property?     @relation(fields: [propertyId], references: [id])
  unitId          String?       @map("unit_id")
  unit            Unit?         @relation(fields: [unitId], references: [id])
  assetId         String?       @map("asset_id")
  asset           Asset?        @relation(fields: [assetId], references: [id])
  zoneId          String        @map("zone_id")
  zone            Zone          @relation(fields: [zoneId], references: [id])
  complaintTypeId String        @map("complaint_type_id")
  complaintType   ComplaintType @relation(fields: [complaintTypeId], references: [id])
  requestType     RequestType   @default(ON_CALL) @map("request_type")
  priority        Priority      @default(MEDIUM)
  status          RequestStatus @default(NEW)
  source          RequestSource @default(PORTAL)
  title           String
  description     String?
  customerNotes   String?       @map("customer_notes")
  internalNotes   String?       @map("internal_notes")
  assignedToId    String?       @map("assigned_to_id")
  assignedTo      Employee?     @relation("AssignedEmployee", fields: [assignedToId], references: [id])
  slaStartAt      DateTime?     @map("sla_start_at")
  slaDueAt        DateTime?     @map("sla_due_at")
  startedAt       DateTime?     @map("started_at")
  completedAt     DateTime?     @map("completed_at")
  closedAt        DateTime?     @map("closed_at")
  createdAt       DateTime      @default(now()) @map("audit_create_date")
  createdById     String?       @map("audit_create_by")
  updatedAt       DateTime      @updatedAt @map("audit_change_date")
  updatedById     String?       @map("audit_change_by")

  // Relations
  timeline      RequestTimeline[]
  attachments   RequestAttachment[]
  quotations    Quotation[]
  schedules     Schedule[]
  materialUsage MaterialUsage[]
  invoice       Invoice?
  amcSchedule   AmcServiceSchedule?

  // New workflow relations
  siteVisits SiteVisit[]
  estimates  Estimate[]
  workOrders WorkOrder[]
  reviews    CustomerReview[]
  comments   ServiceRequestComment[]

  @@map("service_requests")
  @@schema("fixitbh_ac")
}

enum RequestType {
  ON_CALL
  EMERGENCY
  AMC
  WARRANTY

  @@schema("fixitbh_ac")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  EMERGENCY

  @@schema("fixitbh_ac")
}

enum RequestStatus {
  NEW
  ASSIGNED
  SITE_VISIT_SCHEDULED
  SITE_VISIT_COMPLETED
  ESTIMATION_IN_PROGRESS
  ESTIMATE_PENDING_APPROVAL
  ESTIMATE_APPROVED
  QUOTATION_IN_PROGRESS
  QUOTE_SENT
  QUOTE_APPROVED
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  INVOICED
  CLOSED
  CANCELLED

  @@schema("fixitbh_ac")
}

enum RequestSource {
  PORTAL
  MOBILE
  AI_CHAT
  PHONE
  EMAIL
  WALK_IN

  @@schema("fixitbh_ac")
}

model ComplaintType {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  serviceRequests     ServiceRequest[]
  slaConfigs          SlaConfig[]
  amcContractServices AmcContractService[]
  amcServiceSchedules AmcServiceSchedule[]

  @@map("complaint_types")
  @@schema("fixitbh_ac")
}

model ActionTemplate {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  nameAr        String?  @map("name_ar")
  description   String?  @db.Text
  descriptionAr String?  @map("description_ar") @db.Text
  sortOrder     Int      @default(0) @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("audit_create_date")
  createdById   String?  @map("audit_create_by")
  updatedAt     DateTime @updatedAt @map("audit_change_date")
  updatedById   String?  @map("audit_change_by")

  @@map("action_templates")
  @@schema("fixitbh_ac")
}

model RequestTimeline {
  id               String         @id @default(cuid())
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  action           String
  description      String?
  performedBy      String?        @map("performed_by")
  performer        User?          @relation("TimelinePerformer", fields: [performedBy], references: [id])
  createdAt        DateTime       @default(now()) @map("audit_create_date")
  createdById      String?        @map("audit_create_by")

  @@map("request_timeline")
  @@schema("fixitbh_ac")
}

model ServiceRequestComment {
  id               String         @id @default(cuid())
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)

  // Comment content
  content     String
  commentType CommentType @default(INTERNAL_NOTE) @map("comment_type")

  // Visibility
  isInternal       Boolean @default(true) @map("is_internal") // Internal notes vs customer visible
  isCustomerAuthor Boolean @default(false) @map("is_customer_author") // Was this written by customer?

  // Contact tracking (for phone/email interactions)
  contactMethod   String?   @map("contact_method") // "PHONE", "EMAIL", "IN_PERSON", "WHATSAPP"
  contactNumber   String?   @map("contact_number") // Phone number or email used
  contactDuration Int?      @map("contact_duration") // Duration in seconds for calls
  contactedAt     DateTime? @map("contacted_at") // When the contact happened

  // Scheduling preference from this conversation
  preferredDate String? @map("preferred_date") // e.g., "2024-12-03"
  preferredTime String? @map("preferred_time") // e.g., "10:30 AM" or "16:00"

  // Metadata
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  createdBy   User?    @relation("CommentCreator", fields: [createdById], references: [id])
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@index([serviceRequestId])
  @@index([commentType])
  @@map("service_request_comments")
  @@schema("fixitbh_ac")
}

enum CommentType {
  INTERNAL_NOTE // Internal staff note
  CUSTOMER_CALL // Outbound call to customer
  CUSTOMER_CALLED // Inbound call from customer
  EMAIL_SENT // Email sent to customer
  EMAIL_RECEIVED // Email from customer
  SMS_SENT // SMS sent to customer
  SMS_RECEIVED // SMS from customer
  WHATSAPP // WhatsApp message
  CUSTOMER_MESSAGE // Message from customer portal
  SITE_VISIT_NOTE // Note from site visit
  SCHEDULING_NOTE // Note about scheduling preference

  @@schema("fixitbh_ac")
}

model RequestAttachment {
  id               String         @id @default(cuid())
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  fileName         String         @map("file_name")
  fileType         String         @map("file_type")
  fileSize         Int            @map("file_size")
  filePath         String         @map("file_path")
  uploadedBy       String?        @map("uploaded_by")
  createdAt        DateTime       @default(now()) @map("audit_create_date")
  createdById      String?        @map("audit_create_by")

  @@map("request_attachments")
  @@schema("fixitbh_ac")
}

// ==================== SITE VISIT ====================

model SiteVisit {
  id               String         @id @default(cuid())
  visitNo          String         @unique @map("visit_no") // e.g., SV-2025-0001
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])

  // Scheduling
  scheduledDate DateTime  @map("scheduled_date")
  scheduledTime String?   @map("scheduled_time") // e.g., "09:00-12:00"
  actualDate    DateTime? @map("actual_date")

  // Assignment
  assignedToId String?   @map("assigned_to_id")
  assignedTo   Employee? @relation("SiteVisitAssignee", fields: [assignedToId], references: [id])

  // Status
  status SiteVisitStatus @default(SCHEDULED)

  // Visit outcome
  findings          String? @db.Text
  recommendations   String? @db.Text
  photos            Json? // Array of photo URLs
  customerPresent   Boolean @default(true) @map("customer_present")
  customerSignature String? @map("customer_signature") // Base64 or URL

  // Duration tracking
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  estimates Estimate[]

  @@map("site_visits")
  @@schema("fixitbh_ac")
}

enum SiteVisitStatus {
  SCHEDULED // Visit scheduled
  CONFIRMED // Customer confirmed
  IN_PROGRESS // Visit started
  COMPLETED // Visit completed
  CANCELLED // Visit cancelled
  NO_ACCESS // Customer not available / no access
  RESCHEDULED // Moved to different date

  @@schema("fixitbh_ac")
}

// ==================== ESTIMATE (Internal Detailed Costing) ====================

model Estimate {
  id         String @id @default(cuid())
  estimateNo String @unique @map("estimate_no") // e.g., EST-2025-0001

  // Links
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  siteVisitId      String?        @map("site_visit_id")
  siteVisit        SiteVisit?     @relation(fields: [siteVisitId], references: [id])

  // Versioning (for revisions)
  version          Int        @default(1)
  parentEstimateId String?    @map("parent_estimate_id")
  parentEstimate   Estimate?  @relation("EstimateVersions", fields: [parentEstimateId], references: [id])
  revisions        Estimate[] @relation("EstimateVersions")
  isLatestVersion  Boolean    @default(true) @map("is_latest_version")

  // Estimate Details
  title       String
  description String?        @db.Text
  scope       String?        @db.Text // Scope of work
  status      EstimateStatus @default(DRAFT)

  // Cost Breakdown
  materialCost  Decimal @default(0) @map("material_cost") @db.Decimal(10, 3)
  laborCost     Decimal @default(0) @map("labor_cost") @db.Decimal(10, 3)
  equipmentCost Decimal @default(0) @map("equipment_cost") @db.Decimal(10, 3)
  otherCost     Decimal @default(0) @map("other_cost") @db.Decimal(10, 3)
  subtotal      Decimal @default(0) @db.Decimal(10, 3)

  // Profit & Tax
  profitMarginType  DiscountType? @map("profit_margin_type") // PERCENTAGE or FIXED
  profitMarginValue Decimal       @default(0) @map("profit_margin_value") @db.Decimal(10, 3)
  profitAmount      Decimal       @default(0) @map("profit_amount") @db.Decimal(10, 3)

  // VAT/Tax
  vatRate   Decimal @default(10) @map("vat_rate") @db.Decimal(5, 2) // e.g., 10.00 for 10%
  vatAmount Decimal @default(0) @map("vat_amount") @db.Decimal(10, 3)

  // Discount (if any)
  discountType   DiscountType? @map("discount_type")
  discountValue  Decimal       @default(0) @map("discount_value") @db.Decimal(10, 3)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 3)
  discountReason String?       @map("discount_reason")

  // Totals
  totalBeforeVat Decimal @default(0) @map("total_before_vat") @db.Decimal(10, 3)
  total          Decimal @default(0) @db.Decimal(10, 3)
  currency       String  @default("BHD")

  // Timeline
  estimatedDuration  Int?      @map("estimated_duration") // in hours
  estimatedStartDate DateTime? @map("estimated_start_date")
  estimatedEndDate   DateTime? @map("estimated_end_date")

  // Internal Notes
  internalNotes String? @map("internal_notes") @db.Text
  assumptions   String? @db.Text // Assumptions made
  exclusions    String? @db.Text // What's not included

  // Approval Workflow
  submittedAt   DateTime? @map("submitted_at")
  submittedById String?   @map("submitted_by_id")
  submittedBy   User?     @relation("EstimateSubmittedBy", fields: [submittedById], references: [id])

  approvedAt   DateTime? @map("approved_at")
  approvedById String?   @map("approved_by_id")
  approvedBy   User?     @relation("EstimateApprovedBy", fields: [approvedById], references: [id])

  rejectedAt      DateTime? @map("rejected_at")
  rejectedById    String?   @map("rejected_by_id")
  rejectedBy      User?     @relation("EstimateRejectedBy", fields: [rejectedById], references: [id])
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Conversion to Quote
  convertedToQuoteId String?   @unique @map("converted_to_quote_id")
  convertedToQuote   Quote?    @relation("EstimateToQuote", fields: [convertedToQuoteId], references: [id])
  convertedAt        DateTime? @map("converted_at")

  // Audit
  createdById String   @map("created_by_id")
  createdBy   User     @relation("EstimateCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("audit_create_date")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  items      EstimateItem[]
  laborItems EstimateLaborItem[]
  activities EstimateActivity[]
  workOrders WorkOrder[]

  @@index([serviceRequestId])
  @@index([status])
  @@map("estimates")
  @@schema("fixitbh_ac")
}

model EstimateItem {
  id         String   @id @default(cuid())
  estimateId String   @map("estimate_id")
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  // Item details
  sortOrder Int              @default(0) @map("sort_order")
  itemType  EstimateItemType @default(MATERIAL) @map("item_type")

  // Link to inventory item (optional)
  inventoryItemId String?        @map("inventory_item_id")
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  // Item info (can override inventory item or be custom)
  name        String
  description String?
  sku         String? // Part number / SKU

  // Quantity & Pricing
  quantity  Decimal @default(1) @db.Decimal(10, 3)
  unit      String  @default("unit") // e.g., "piece", "sqm", "liter"
  unitCost  Decimal @map("unit_cost") @db.Decimal(10, 3)
  totalCost Decimal @map("total_cost") @db.Decimal(10, 3)

  // Markup for this item (optional)
  markupType   DiscountType? @map("markup_type")
  markupValue  Decimal       @default(0) @map("markup_value") @db.Decimal(10, 3)
  markupAmount Decimal       @default(0) @map("markup_amount") @db.Decimal(10, 3)

  // Final price (cost + markup)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 3)

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("estimate_items")
  @@schema("fixitbh_ac")
}

model EstimateLaborItem {
  id         String   @id @default(cuid())
  estimateId String   @map("estimate_id")
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  // Labor details
  sortOrder Int               @default(0) @map("sort_order")
  laborType EstimateLaborType @default(TECHNICIAN) @map("labor_type")

  // Worker info
  description String // e.g., "Painter", "Helper", "Electrician"

  // Time & Rate
  quantity   Int     @default(1) // Number of workers
  hours      Decimal @db.Decimal(10, 2) // Hours of work
  hourlyRate Decimal @map("hourly_rate") @db.Decimal(10, 3)
  totalCost  Decimal @map("total_cost") @db.Decimal(10, 3)

  // Markup for labor (optional)
  markupType   DiscountType? @map("markup_type")
  markupValue  Decimal       @default(0) @map("markup_value") @db.Decimal(10, 3)
  markupAmount Decimal       @default(0) @map("markup_amount") @db.Decimal(10, 3)

  // Final price (cost + markup)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 3)

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("estimate_labor_items")
  @@schema("fixitbh_ac")
}

model EstimateActivity {
  id            String   @id @default(cuid())
  estimateId    String   @map("estimate_id")
  estimate      Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  action        String // e.g., "CREATED", "SUBMITTED", "APPROVED", "REJECTED", "REVISED"
  description   String?
  metadata      Json? // Additional context
  performedById String?  @map("performed_by_id")
  performedBy   User?    @relation("EstimateActivityBy", fields: [performedById], references: [id])
  createdAt     DateTime @default(now()) @map("audit_create_date")
  createdById   String?  @map("audit_create_by")

  @@map("estimate_activities")
  @@schema("fixitbh_ac")
}

enum EstimateStatus {
  DRAFT // Being prepared
  SUBMITTED // Submitted for approval
  PENDING_MANAGER_APPROVAL // Awaiting manager approval
  REVISION_REQUESTED // Manager requested changes
  APPROVED // Manager approved
  REJECTED // Manager rejected
  CONVERTED // Converted to customer quote
  CANCELLED // Cancelled

  @@schema("fixitbh_ac")
}

enum EstimateItemType {
  MATERIAL // Materials/parts
  EQUIPMENT // Equipment/tools
  CONSUMABLE // Consumables
  TRANSPORT // Transport/delivery
  OTHER // Other costs

  @@schema("fixitbh_ac")
}

enum EstimateLaborType {
  TECHNICIAN // Skilled technician
  HELPER // Helper/assistant
  SUPERVISOR // Supervisor
  SPECIALIST // Specialist (e.g., electrician, plumber)
  CONTRACTOR // External contractor

  @@schema("fixitbh_ac")
}

// ==================== SLA ====================

model SlaConfig {
  id              String         @id @default(cuid())
  name            String
  priority        Priority
  complaintTypeId String?        @map("complaint_type_id")
  complaintType   ComplaintType? @relation(fields: [complaintTypeId], references: [id])
  responseTime    Int            @map("response_time") // in minutes
  resolutionTime  Int            @map("resolution_time") // in minutes
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("audit_create_date")
  createdById     String?        @map("audit_create_by")
  updatedAt       DateTime       @updatedAt @map("audit_change_date")
  updatedById     String?        @map("audit_change_by")

  @@map("sla_configs")
  @@schema("fixitbh_ac")
}

// ==================== QUOTATION ====================

model Quotation {
  id               String          @id @default(cuid())
  quotationNo      String          @unique @map("quotation_no")
  serviceRequestId String          @map("service_request_id")
  serviceRequest   ServiceRequest  @relation(fields: [serviceRequestId], references: [id])
  status           QuotationStatus @default(DRAFT)
  subtotal         Decimal         @db.Decimal(10, 2)
  taxAmount        Decimal         @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount   Decimal         @default(0) @map("discount_amount") @db.Decimal(10, 2)
  total            Decimal         @db.Decimal(10, 2)
  notes            String?
  validUntil       DateTime?       @map("valid_until")
  approvedAt       DateTime?       @map("approved_at")
  approvedBy       String?         @map("approved_by")
  createdBy        String          @map("created_by")
  createdAt        DateTime        @default(now()) @map("audit_create_date")
  createdById      String?         @map("audit_create_by")
  updatedAt        DateTime        @updatedAt @map("audit_change_date")
  updatedById      String?         @map("audit_change_by")

  // Relations
  items QuotationItem[]

  @@map("quotations")
  @@schema("fixitbh_ac")
}

enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED

  @@schema("fixitbh_ac")
}

model QuotationItem {
  id          String    @id @default(cuid())
  quotationId String    @map("quotation_id")
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  itemType    ItemType  @default(SERVICE) @map("item_type")
  description String
  quantity    Int       @default(1)
  unitPrice   Decimal   @map("unit_price") @db.Decimal(10, 2)
  total       Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now()) @map("audit_create_date")
  createdById String?   @map("audit_create_by")

  @@map("quotation_items")
  @@schema("fixitbh_ac")
}

enum ItemType {
  SERVICE
  MATERIAL
  LABOR

  @@schema("fixitbh_ac")
}

// ==================== SCHEDULE ====================

model Schedule {
  id               String         @id @default(cuid())
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  scheduledDate    DateTime       @map("scheduled_date")
  startTime        DateTime?      @map("start_time")
  endTime          DateTime?      @map("end_time")
  status           ScheduleStatus @default(SCHEDULED)
  notes            String?
  createdBy        String         @map("created_by")
  createdAt        DateTime       @default(now()) @map("audit_create_date")
  createdById      String?        @map("audit_create_by")
  updatedAt        DateTime       @updatedAt @map("audit_change_date")
  updatedById      String?        @map("audit_change_by")

  // Relations
  team ScheduleTeam[]

  @@map("schedules")
  @@schema("fixitbh_ac")
}

enum ScheduleStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED

  @@schema("fixitbh_ac")
}

model ScheduleTeam {
  scheduleId  String   @map("schedule_id")
  employeeId  String   @map("employee_id")
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  employee    Employee @relation(fields: [employeeId], references: [id])
  isLead      Boolean  @default(false) @map("is_lead")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@id([scheduleId, employeeId])
  @@map("schedule_team")
  @@schema("fixitbh_ac")
}

// ==================== INVENTORY ====================

model InventoryItem {
  id           String            @id @default(cuid())
  itemNo       String            @unique @map("item_no")
  name         String
  nameAr       String?           @map("name_ar")
  categoryId   String            @map("category_id")
  category     InventoryCategory @relation(fields: [categoryId], references: [id])
  description  String?
  unit         String            @default("piece")
  unitPrice    Decimal           @default(0) @map("unit_price") @db.Decimal(10, 2)
  currentStock Int               @default(0) @map("current_stock")
  minStock     Int               @default(0) @map("min_stock")
  maxStock     Int?              @map("max_stock")
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("audit_create_date")
  createdById  String?           @map("audit_create_by")
  updatedAt    DateTime          @updatedAt @map("audit_change_date")
  updatedById  String?           @map("audit_change_by")

  // Relations
  materialUsage  MaterialUsage[]
  stockMovements StockMovement[]
  estimateItems  EstimateItem[]
  workOrderItems WorkOrderItem[]

  @@map("inventory_items")
  @@schema("fixitbh_ac")
}

model InventoryCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  items InventoryItem[]

  @@map("inventory_categories")
  @@schema("fixitbh_ac")
}

model MaterialUsage {
  id               String         @id @default(cuid())
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  itemId           String         @map("item_id")
  item             InventoryItem  @relation(fields: [itemId], references: [id])
  quantity         Int
  unitPrice        Decimal        @map("unit_price") @db.Decimal(10, 2)
  total            Decimal        @db.Decimal(10, 2)
  usedBy           String         @map("used_by")
  usedAt           DateTime       @default(now()) @map("used_at")
  createdAt        DateTime       @default(now()) @map("audit_create_date")
  createdById      String?        @map("audit_create_by")

  @@map("material_usage")
  @@schema("fixitbh_ac")
}

model StockMovement {
  id           String        @id @default(cuid())
  itemId       String        @map("item_id")
  item         InventoryItem @relation(fields: [itemId], references: [id])
  movementType MovementType  @map("movement_type")
  quantity     Int
  unitPrice    Decimal?      @map("unit_price") @db.Decimal(10, 2)
  reference    String?
  notes        String?
  createdBy    String        @map("created_by")
  createdAt    DateTime      @default(now()) @map("audit_create_date")
  createdById  String?       @map("audit_create_by")

  @@map("stock_movements")
  @@schema("fixitbh_ac")
}

enum MovementType {
  PURCHASE
  USAGE
  ADJUSTMENT
  RETURN
  TRANSFER

  @@schema("fixitbh_ac")
}

// ==================== INVOICE ====================

model Invoice {
  id               String         @id @default(cuid())
  invoiceNo        String         @unique @map("invoice_no")
  serviceRequestId String         @unique @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  customerId       String         @map("customer_id")
  customer         Customer       @relation(fields: [customerId], references: [id])
  status           InvoiceStatus  @default(DRAFT)
  subtotal         Decimal        @db.Decimal(10, 2)
  taxAmount        Decimal        @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount   Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  total            Decimal        @db.Decimal(10, 2)
  paidAmount       Decimal        @default(0) @map("paid_amount") @db.Decimal(10, 2)
  dueDate          DateTime?      @map("due_date")
  paidAt           DateTime?      @map("paid_at")
  notes            String?
  createdBy        String         @map("created_by")
  createdAt        DateTime       @default(now()) @map("audit_create_date")
  createdById      String?        @map("audit_create_by")
  updatedAt        DateTime       @updatedAt @map("audit_change_date")
  updatedById      String?        @map("audit_change_by")

  // Relations
  items       InvoiceItem[]
  payments    Payment[]
  amcPayments AmcPaymentSchedule[]
  receipts    Receipt[]
  fromQuote   Quote?               @relation("QuoteToInvoice")

  @@map("invoices")
  @@schema("fixitbh_ac")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED

  @@schema("fixitbh_ac")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String   @map("invoice_id")
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  itemType    ItemType @default(SERVICE) @map("item_type")
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("invoice_items")
  @@schema("fixitbh_ac")
}

model Payment {
  id            String        @id @default(cuid())
  paymentNo     String        @unique @map("payment_no")
  invoiceId     String        @map("invoice_id")
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod @default(CASH) @map("payment_method")
  reference     String?
  notes         String?
  receivedBy    String        @map("received_by")
  receivedAt    DateTime      @default(now()) @map("received_at")
  createdAt     DateTime      @default(now()) @map("audit_create_date")
  createdById   String?       @map("audit_create_by")

  // Relations
  receipt Receipt?

  @@map("payments")
  @@schema("fixitbh_ac")
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHEQUE
  ONLINE

  @@schema("fixitbh_ac")
}

// ==================== NOTIFICATION ====================

model NotificationTemplate {
  id      String              @id @default(cuid())
  name    String              @unique
  type    NotificationType
  channel NotificationChannel

  // Content
  title     String?
  titleAr   String? @map("title_ar")
  subject   String?
  subjectAr String? @map("subject_ar")
  body      String // Supports placeholders like {{customer_name}}
  bodyAr    String? @map("body_ar")

  // Settings
  isActive  Boolean @default(true) @map("is_active")
  isDefault Boolean @default(false) @map("is_default")

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@map("notification_templates")
  @@schema("fixitbh_ac")
}

enum NotificationType {
  // Legacy
  REQUEST_CREATED
  REQUEST_ASSIGNED
  REQUEST_SCHEDULED
  REQUEST_STARTED
  REQUEST_COMPLETED
  QUOTATION_SENT
  QUOTATION_APPROVED
  INVOICE_SENT
  PAYMENT_RECEIVED
  SLA_WARNING
  SLA_BREACH
  // Appointment
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_RESCHEDULED
  APPOINTMENT_CANCELLED
  // Technician
  TECHNICIAN_ASSIGNED
  TECHNICIAN_EN_ROUTE
  TECHNICIAN_ARRIVED
  // Work Order
  WORK_STARTED
  WORK_COMPLETED
  // Quote/Invoice
  QUOTE_SENT
  PAYMENT_REMINDER
  // Review
  REVIEW_REQUEST
  // General
  GENERAL

  @@schema("fixitbh_ac")
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
  WHATSAPP

  @@schema("fixitbh_ac")
}

enum NotificationStatus {
  PENDING
  SCHEDULED
  SENT
  DELIVERED
  READ
  FAILED
  CANCELLED

  @@schema("fixitbh_ac")
}

// ==================== AMC (Annual Maintenance Contract) ====================

model AmcContract {
  id         String   @id @default(cuid())
  contractNo String   @unique @map("contract_no")
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])

  // Contract Period
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // Financial
  contractValue Decimal         @map("contract_value") @db.Decimal(10, 3)
  paymentTerms  AmcPaymentTerms @default(MONTHLY) @map("payment_terms")

  // Status
  status AmcStatus @default(DRAFT)

  // Auto-renewal
  autoRenew           Boolean @default(false) @map("auto_renew")
  renewalReminderDays Int?    @map("renewal_reminder_days") // Days before expiry to remind

  // Contract Details
  terms String? @db.Text // Terms and conditions
  notes String? @db.Text

  // Renewal tracking
  renewedFromId String?       @map("renewed_from_id")
  renewedFrom   AmcContract?  @relation("AmcRenewal", fields: [renewedFromId], references: [id])
  renewedTo     AmcContract[] @relation("AmcRenewal")

  // Audit
  createdById        String    @map("created_by_id")
  createdBy          User      @relation("AmcCreatedBy", fields: [createdById], references: [id])
  approvedById       String?   @map("approved_by_id")
  approvedBy         User?     @relation("AmcApprovedBy", fields: [approvedById], references: [id])
  approvedAt         DateTime? @map("approved_at")
  cancelledById      String?   @map("cancelled_by_id")
  cancelledBy        User?     @relation("AmcCancelledBy", fields: [cancelledById], references: [id])
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason")
  createdAt          DateTime  @default(now()) @map("audit_create_date")
  updatedAt          DateTime  @updatedAt @map("audit_change_date")
  updatedById        String?   @map("audit_change_by")

  // Relations
  properties AmcContractProperty[]
  services   AmcContractService[]
  schedules  AmcServiceSchedule[]
  payments   AmcPaymentSchedule[]

  @@map("amc_contracts")
  @@schema("fixitbh_ac")
}

model AmcContractProperty {
  id         String      @id @default(cuid())
  contractId String      @map("contract_id")
  contract   AmcContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Can link to Unit (new) or Property (legacy)
  unitId     String?   @map("unit_id")
  unit       Unit?     @relation(fields: [unitId], references: [id])
  propertyId String?   @map("property_id")
  property   Property? @relation(fields: [propertyId], references: [id])

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@unique([contractId, unitId])
  @@unique([contractId, propertyId])
  @@map("amc_contract_properties")
  @@schema("fixitbh_ac")
}

model AmcContractService {
  id              String        @id @default(cuid())
  contractId      String        @map("contract_id")
  contract        AmcContract   @relation(fields: [contractId], references: [id], onDelete: Cascade)
  complaintTypeId String        @map("complaint_type_id")
  complaintType   ComplaintType @relation(fields: [complaintTypeId], references: [id])

  // Service frequency
  frequency     AmcServiceFrequency @default(MONTHLY)
  visitsPerYear Int                 @default(12) @map("visits_per_year")

  // Cost allocation (optional - for detailed contract pricing)
  serviceCost Decimal? @map("service_cost") @db.Decimal(10, 3)

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@unique([contractId, complaintTypeId])
  @@map("amc_contract_services")
  @@schema("fixitbh_ac")
}

model AmcServiceSchedule {
  id         String      @id @default(cuid())
  contractId String      @map("contract_id")
  contract   AmcContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Property for this visit
  unitId     String?   @map("unit_id")
  unit       Unit?     @relation(fields: [unitId], references: [id])
  propertyId String?   @map("property_id")
  property   Property? @relation(fields: [propertyId], references: [id])

  // Service type
  complaintTypeId String        @map("complaint_type_id")
  complaintType   ComplaintType @relation(fields: [complaintTypeId], references: [id])

  // Schedule
  scheduledDate DateTime          @map("scheduled_date")
  scheduledTime String?           @map("scheduled_time") // e.g., "09:00-12:00"
  status        AmcScheduleStatus @default(SCHEDULED)

  // Link to actual service request when created
  serviceRequestId String?         @unique @map("service_request_id")
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  // Completion tracking
  completedAt   DateTime? @map("completed_at")
  completedById String?   @map("completed_by_id")
  completedBy   User?     @relation("AmcScheduleCompletedBy", fields: [completedById], references: [id])

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@map("amc_service_schedules")
  @@schema("fixitbh_ac")
}

model AmcPaymentSchedule {
  id         String      @id @default(cuid())
  contractId String      @map("contract_id")
  contract   AmcContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Payment details
  installmentNo Int              @map("installment_no")
  dueDate       DateTime         @map("due_date")
  amount        Decimal          @db.Decimal(10, 3)
  status        AmcPaymentStatus @default(PENDING)

  // Payment tracking
  paidAt           DateTime?      @map("paid_at")
  paidAmount       Decimal?       @map("paid_amount") @db.Decimal(10, 3)
  paymentMethod    PaymentMethod? @map("payment_method")
  paymentReference String?        @map("payment_reference")

  // Link to invoice if generated
  invoiceId String?  @map("invoice_id")
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@unique([contractId, installmentNo])
  @@map("amc_payment_schedules")
  @@schema("fixitbh_ac")
}

enum AmcStatus {
  DRAFT // Contract being prepared
  PENDING_APPROVAL // Awaiting customer/manager approval
  ACTIVE // Contract is active
  SUSPENDED // Temporarily suspended (e.g., payment issues)
  EXPIRED // Contract period ended
  CANCELLED // Contract was cancelled
  RENEWED // Contract was renewed (new contract created)

  @@schema("fixitbh_ac")
}

enum AmcPaymentTerms {
  UPFRONT // Full payment at start
  MONTHLY // Monthly installments
  QUARTERLY // Every 3 months
  SEMI_ANNUAL // Every 6 months
  ANNUAL // Once a year

  @@schema("fixitbh_ac")
}

enum AmcServiceFrequency {
  WEEKLY // Every week
  BI_WEEKLY // Every 2 weeks
  MONTHLY // Once a month
  BI_MONTHLY // Every 2 months
  QUARTERLY // Every 3 months
  SEMI_ANNUAL // Every 6 months
  ANNUAL // Once a year

  @@schema("fixitbh_ac")
}

enum AmcScheduleStatus {
  SCHEDULED // Planned
  CONFIRMED // Customer confirmed
  IN_PROGRESS // Work started
  COMPLETED // Work done
  MISSED // Was not performed
  RESCHEDULED // Moved to different date
  CANCELLED // Cancelled

  @@schema("fixitbh_ac")
}

enum AmcPaymentStatus {
  PENDING // Not yet due
  DUE // Due for payment
  PAID // Fully paid
  OVERDUE // Past due date
  PARTIALLY_PAID // Partial payment received
  WAIVED // Payment waived

  @@schema("fixitbh_ac")
}

// ==================== QUOTE MANAGEMENT (with versioning) ====================

model Quote {
  id      String @id @default(cuid())
  quoteNo String @unique @map("quote_no") // e.g., QUO-2025-0001

  // Customer & Property
  customerId String    @map("customer_id")
  customer   Customer  @relation(fields: [customerId], references: [id])
  unitId     String?   @map("unit_id")
  unit       Unit?     @relation(fields: [unitId], references: [id])
  propertyId String?   @map("property_id")
  property   Property? @relation(fields: [propertyId], references: [id])

  // Optional link to service request
  serviceRequestId String? @map("service_request_id")

  // Versioning
  version         Int     @default(1)
  parentQuoteId   String? @map("parent_quote_id") // Original quote if this is a revision
  parentQuote     Quote?  @relation("QuoteVersions", fields: [parentQuoteId], references: [id])
  revisions       Quote[] @relation("QuoteVersions")
  isLatestVersion Boolean @default(true) @map("is_latest_version")

  // Quote Details
  title       String
  description String?     @db.Text
  status      QuoteStatus @default(DRAFT)

  // Financial
  subtotal       Decimal       @db.Decimal(10, 3)
  taxRate        Decimal       @default(0) @map("tax_rate") @db.Decimal(5, 2) // e.g., 10.00 for 10%
  taxAmount      Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 3)
  discountType   DiscountType? @map("discount_type")
  discountValue  Decimal       @default(0) @map("discount_value") @db.Decimal(10, 3)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 3)
  total          Decimal       @db.Decimal(10, 3)
  currency       String        @default("BHD")

  // Validity
  validFrom  DateTime @default(now()) @map("valid_from")
  validUntil DateTime @map("valid_until")

  // Terms
  terms         String? @db.Text
  notes         String? @db.Text
  internalNotes String? @map("internal_notes") @db.Text

  // Customer Response
  customerResponse QuoteResponse? @map("customer_response")
  respondedAt      DateTime?      @map("responded_at")
  responseNotes    String?        @map("response_notes") @db.Text

  // Workflow
  sentAt          DateTime? @map("sent_at")
  sentById        String?   @map("sent_by_id")
  sentBy          User?     @relation("QuoteSentBy", fields: [sentById], references: [id])
  approvedAt      DateTime? @map("approved_at")
  approvedById    String?   @map("approved_by_id")
  approvedBy      User?     @relation("QuoteApprovedBy", fields: [approvedById], references: [id])
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?   @map("rejection_reason")

  // Conversion to Invoice
  convertedToInvoiceId String?   @unique @map("converted_to_invoice_id")
  convertedToInvoice   Invoice?  @relation("QuoteToInvoice", fields: [convertedToInvoiceId], references: [id])
  convertedAt          DateTime? @map("converted_at")

  // Audit
  createdById String   @map("created_by_id")
  createdBy   User     @relation("QuoteCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("audit_create_date")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  items        QuoteItem[]
  attachments  QuoteAttachment[]
  activities   QuoteActivity[]
  fromEstimate Estimate?         @relation("EstimateToQuote")
  workOrders   WorkOrder[]

  @@index([customerId])
  @@index([status])
  @@index([parentQuoteId])
  @@map("quotes")
  @@schema("fixitbh_ac")
}

model QuoteItem {
  id      String @id @default(cuid())
  quoteId String @map("quote_id")
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Item details
  sortOrder   Int           @default(0) @map("sort_order")
  itemType    QuoteItemType @default(SERVICE) @map("item_type")
  name        String
  description String?
  sku         String? // Stock Keeping Unit / Item code

  // Quantity & Pricing
  quantity  Decimal @default(1) @db.Decimal(10, 3)
  unit      String  @default("unit") // e.g., "hour", "piece", "sqm"
  unitPrice Decimal @map("unit_price") @db.Decimal(10, 3)

  // Discount per item
  discountType   DiscountType? @map("discount_type")
  discountValue  Decimal       @default(0) @map("discount_value") @db.Decimal(10, 3)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 3)

  // Tax per item (optional - can use quote-level tax instead)
  taxRate   Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount Decimal @default(0) @map("tax_amount") @db.Decimal(10, 3)

  // Totals
  subtotal Decimal @db.Decimal(10, 3) // quantity * unitPrice
  total    Decimal @db.Decimal(10, 3) // subtotal - discount + tax

  notes       String?
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("quote_items")
  @@schema("fixitbh_ac")
}

model QuoteAttachment {
  id          String   @id @default(cuid())
  quoteId     String   @map("quote_id")
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  fileName    String   @map("file_name")
  fileType    String   @map("file_type")
  fileSize    Int      @map("file_size")
  filePath    String   @map("file_path")
  uploadedBy  String?  @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("quote_attachments")
  @@schema("fixitbh_ac")
}

model QuoteActivity {
  id            String   @id @default(cuid())
  quoteId       String   @map("quote_id")
  quote         Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  action        String // e.g., "CREATED", "SENT", "REVISED", "APPROVED", "REJECTED"
  description   String?
  metadata      Json? // Additional context
  performedById String?  @map("performed_by_id")
  performedBy   User?    @relation("QuoteActivityBy", fields: [performedById], references: [id])
  createdAt     DateTime @default(now()) @map("audit_create_date")
  createdById   String?  @map("audit_create_by")

  @@map("quote_activities")
  @@schema("fixitbh_ac")
}

enum QuoteStatus {
  DRAFT // Being prepared
  PENDING_REVIEW // Internal review
  SENT // Sent to customer
  VIEWED // Customer viewed
  REVISED // New version created (this version is old)
  ACCEPTED // Customer accepted
  REJECTED // Customer rejected
  EXPIRED // Validity period ended
  CONVERTED // Converted to invoice
  CANCELLED // Cancelled by staff

  @@schema("fixitbh_ac")
}

enum QuoteItemType {
  SERVICE // Service charge
  LABOR // Labor/manpower
  MATERIAL // Parts/materials
  EQUIPMENT // Equipment rental
  TRAVEL // Travel/transport
  DISCOUNT // Discount line item
  OTHER // Other charges

  @@schema("fixitbh_ac")
}

enum QuoteResponse {
  PENDING // No response yet
  REVIEWING // Customer is reviewing
  NEGOTIATING // Customer wants changes
  ACCEPTED // Customer accepted
  REJECTED // Customer rejected

  @@schema("fixitbh_ac")
}

enum DiscountType {
  PERCENTAGE // e.g., 10% off
  FIXED // e.g., BHD 50 off

  @@schema("fixitbh_ac")
}

// ==================== RECEIPT ====================

model Receipt {
  id        String @id @default(cuid())
  receiptNo String @unique @map("receipt_no") // e.g., RCP-2025-0001

  // Link to Invoice
  invoiceId String  @map("invoice_id")
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  // Link to Payment
  paymentId String?  @unique @map("payment_id")
  payment   Payment? @relation(fields: [paymentId], references: [id])

  // Customer Info (denormalized for receipt printing)
  customerId      String   @map("customer_id")
  customer        Customer @relation(fields: [customerId], references: [id])
  customerName    String   @map("customer_name")
  customerEmail   String?  @map("customer_email")
  customerPhone   String?  @map("customer_phone")
  customerAddress String?  @map("customer_address")

  // Payment Details
  amount           Decimal       @db.Decimal(10, 3)
  paymentMethod    PaymentMethod @map("payment_method")
  paymentDate      DateTime      @map("payment_date")
  paymentReference String?       @map("payment_reference")

  // Invoice Balance
  invoiceTotal   Decimal @map("invoice_total") @db.Decimal(10, 3)
  previouslyPaid Decimal @default(0) @map("previously_paid") @db.Decimal(10, 3)
  balanceAfter   Decimal @map("balance_after") @db.Decimal(10, 3)

  // Receipt Details
  description String?
  notes       String?

  // Printing/Sharing
  printedAt  DateTime? @map("printed_at")
  printCount Int       @default(0) @map("print_count")
  emailedAt  DateTime? @map("emailed_at")

  // Void/Cancel
  isVoided   Boolean   @default(false) @map("is_voided")
  voidedAt   DateTime? @map("voided_at")
  voidedById String?   @map("voided_by_id")
  voidedBy   User?     @relation("ReceiptVoidedBy", fields: [voidedById], references: [id])
  voidReason String?   @map("void_reason")

  // Audit
  createdById String   @map("created_by_id")
  createdBy   User     @relation("ReceiptCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("audit_create_date")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@index([invoiceId])
  @@index([customerId])
  @@index([paymentDate])
  @@map("receipts")
  @@schema("fixitbh_ac")
}

// ==================== AUDIT ====================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@schema("fixitbh_ac")
}

// ==================== WORK ORDER ====================

model WorkOrder {
  id               String         @id @default(cuid())
  workOrderNo      String         @unique @map("work_order_no") // e.g., WO-2025-0001
  serviceRequestId String         @map("service_request_id")
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  quoteId          String?        @map("quote_id")
  quote            Quote?         @relation(fields: [quoteId], references: [id])
  estimateId       String?        @map("estimate_id")
  estimate         Estimate?      @relation(fields: [estimateId], references: [id])
  customerId       String         @map("customer_id")
  customer         Customer       @relation(fields: [customerId], references: [id])

  // Work Details
  title               String
  description         String?
  scope               String? // What work needs to be done
  specialInstructions String? @map("special_instructions")

  // Scheduling
  scheduledDate     DateTime @map("scheduled_date")
  scheduledTime     String?  @map("scheduled_time")
  estimatedDuration Int?     @map("estimated_duration") // in minutes

  // Execution
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  actualDuration Int?      @map("actual_duration") // in minutes

  // Status
  status   WorkOrderStatus @default(PENDING)
  priority Priority        @default(MEDIUM)

  // Completion Details
  workPerformed    String? @map("work_performed")
  technicianNotes  String? @map("technician_notes")
  customerFeedback String? @map("customer_feedback")

  // Signatures
  technicianSignature String?   @map("technician_signature") // Base64 or URL
  customerSignature   String?   @map("customer_signature")
  signedAt            DateTime? @map("signed_at")

  // Financials
  laborCost      Decimal @default(0) @map("labor_cost") @db.Decimal(10, 3)
  materialCost   Decimal @default(0) @map("material_cost") @db.Decimal(10, 3)
  additionalCost Decimal @default(0) @map("additional_cost") @db.Decimal(10, 3)
  totalCost      Decimal @default(0) @map("total_cost") @db.Decimal(10, 3)

  // Audit
  createdById String   @map("created_by_id")
  createdBy   Employee @relation("WorkOrderCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("audit_create_date")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  team         WorkOrderTeam[]
  items        WorkOrderItem[]
  laborEntries WorkOrderLabor[]
  checklists   WorkOrderChecklist[]
  photos       WorkOrderPhoto[]
  activities   WorkOrderActivity[]
  reviews      CustomerReview[]

  @@index([serviceRequestId])
  @@index([customerId])
  @@index([status])
  @@index([scheduledDate])
  @@map("work_orders")
  @@schema("fixitbh_ac")
}

enum WorkOrderStatus {
  PENDING // Created but not scheduled
  SCHEDULED // Assigned to team
  CONFIRMED // Customer confirmed appointment
  EN_ROUTE // Technician on the way
  IN_PROGRESS // Work started
  ON_HOLD // Paused (waiting for parts, customer request)
  COMPLETED // Work finished
  CANCELLED // Cancelled
  REQUIRES_FOLLOWUP // Needs additional work

  @@schema("fixitbh_ac")
}

// Team assigned to work order
model WorkOrderTeam {
  workOrderId String    @map("work_order_id")
  employeeId  String    @map("employee_id")
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  employee    Employee  @relation(fields: [employeeId], references: [id])
  role        String? // e.g., "Lead Technician", "Helper"
  isLead      Boolean   @default(false) @map("is_lead")
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  createdAt   DateTime  @default(now()) @map("audit_create_date")
  createdById String?   @map("audit_create_by")

  @@id([workOrderId, employeeId])
  @@map("work_order_team")
  @@schema("fixitbh_ac")
}

// Materials/parts used in work order
model WorkOrderItem {
  id              String         @id @default(cuid())
  workOrderId     String         @map("work_order_id")
  workOrder       WorkOrder      @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  inventoryItemId String?        @map("inventory_item_id")
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  name        String
  description String?
  quantity    Decimal @db.Decimal(10, 2)
  unit        String  @default("piece")
  unitCost    Decimal @map("unit_cost") @db.Decimal(10, 3)
  totalCost   Decimal @map("total_cost") @db.Decimal(10, 3)

  isFromEstimate Boolean @default(false) @map("is_from_estimate")
  isAdditional   Boolean @default(false) @map("is_additional") // Added during work

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("work_order_items")
  @@schema("fixitbh_ac")
}

// Time tracking for technicians
model WorkOrderLabor {
  id          String    @id @default(cuid())
  workOrderId String    @map("work_order_id")
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  employeeId  String    @map("employee_id")
  employee    Employee  @relation(fields: [employeeId], references: [id])

  // Time tracking
  clockInAt    DateTime  @map("clock_in_at")
  clockOutAt   DateTime? @map("clock_out_at")
  breakMinutes Int       @default(0) @map("break_minutes")
  totalMinutes Int?      @map("total_minutes")

  // Travel time
  travelStartAt DateTime? @map("travel_start_at")
  arrivedAt     DateTime? @map("arrived_at")
  travelMinutes Int?      @map("travel_minutes")

  // Cost
  hourlyRate Decimal  @map("hourly_rate") @db.Decimal(10, 3)
  totalCost  Decimal? @map("total_cost") @db.Decimal(10, 3)

  notes String?

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("work_order_labor")
  @@schema("fixitbh_ac")
}

// Checklist for work completion
model WorkOrderChecklist {
  id          String    @id @default(cuid())
  workOrderId String    @map("work_order_id")
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  // From template or custom
  templateId String? @map("template_id")

  sortOrder  Int     @default(0) @map("sort_order")
  category   String? // e.g., "Pre-Work", "Safety", "Quality", "Post-Work"
  item       String // The checklist item text
  isRequired Boolean @default(true) @map("is_required")

  // Completion
  isCompleted   Boolean   @default(false) @map("is_completed")
  completedAt   DateTime? @map("completed_at")
  completedById String?   @map("completed_by_id")
  completedBy   Employee? @relation(fields: [completedById], references: [id])

  // Response
  response String? // Text response if needed
  value    String? // For measurements/readings

  notes    String?
  photoUrl String? @map("photo_url") // If photo required for this item

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("work_order_checklists")
  @@schema("fixitbh_ac")
}

// Photos for work order (before/during/after)
model WorkOrderPhoto {
  id          String    @id @default(cuid())
  workOrderId String    @map("work_order_id")
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  photoType    PhotoType @map("photo_type")
  url          String
  thumbnailUrl String?   @map("thumbnail_url")
  caption      String?

  takenAt   DateTime @default(now()) @map("taken_at")
  takenById String   @map("taken_by_id")
  takenBy   Employee @relation(fields: [takenById], references: [id])

  // GPS location when photo was taken
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@map("work_order_photos")
  @@schema("fixitbh_ac")
}

enum PhotoType {
  BEFORE // Before work starts
  DURING // During work
  AFTER // After completion
  ISSUE // Problem found
  SIGNATURE // Signature capture
  OTHER

  @@schema("fixitbh_ac")
}

// Work order activity log
model WorkOrderActivity {
  id          String    @id @default(cuid())
  workOrderId String    @map("work_order_id")
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  action      String // e.g., "CREATED", "ASSIGNED", "STARTED", "COMPLETED"
  description String
  metadata    Json?

  performedById String   @map("performed_by_id")
  performedBy   Employee @relation(fields: [performedById], references: [id])
  performedAt   DateTime @default(now()) @map("performed_at")

  @@map("work_order_activities")
  @@schema("fixitbh_ac")
}

// ==================== NOTIFICATION ====================

model Notification {
  id String @id @default(cuid())

  // Recipient
  recipientType RecipientType @map("recipient_type")
  customerId    String?       @map("customer_id")
  customer      Customer?     @relation(fields: [customerId], references: [id])
  employeeId    String?       @map("employee_id")
  employee      Employee?     @relation(fields: [employeeId], references: [id])
  userId        String?       @map("user_id")

  // Channel
  channel NotificationChannel

  // Content
  type       NotificationType
  title      String
  message    String
  templateId String?          @map("template_id")

  // Reference
  referenceType String? @map("reference_type") // e.g., "WorkOrder", "ServiceRequest"
  referenceId   String? @map("reference_id")

  // Delivery
  status        NotificationStatus @default(PENDING)
  scheduledFor  DateTime?          @map("scheduled_for")
  sentAt        DateTime?          @map("sent_at")
  deliveredAt   DateTime?          @map("delivered_at")
  readAt        DateTime?          @map("read_at")
  failedAt      DateTime?          @map("failed_at")
  failureReason String?            @map("failure_reason")

  // For SMS
  phoneNumber String? @map("phone_number")

  // For Email
  email   String?
  subject String?

  // Retry
  retryCount Int @default(0) @map("retry_count")
  maxRetries Int @default(3) @map("max_retries")

  // Metadata
  metadata Json?

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")

  @@index([customerId])
  @@index([employeeId])
  @@index([status])
  @@index([scheduledFor])
  @@map("notifications")
  @@schema("fixitbh_ac")
}

enum RecipientType {
  CUSTOMER
  EMPLOYEE
  USER

  @@schema("fixitbh_ac")
}

// ==================== CUSTOMER REVIEW ====================

model CustomerReview {
  id String @id @default(cuid())

  // Links
  serviceRequestId String?         @map("service_request_id")
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  workOrderId      String?         @map("work_order_id")
  workOrder        WorkOrder?      @relation(fields: [workOrderId], references: [id])
  customerId       String          @map("customer_id")
  customer         Customer        @relation(fields: [customerId], references: [id])

  // Ratings (1-5 stars)
  overallRating         Int  @map("overall_rating") // 1-5
  qualityRating         Int? @map("quality_rating")
  timelinessRating      Int? @map("timeliness_rating")
  professionalismRating Int? @map("professionalism_rating")
  valueRating           Int? @map("value_rating")

  // Feedback
  comment        String?
  wouldRecommend Boolean? @map("would_recommend")

  // Response from company
  responseText  String?   @map("response_text")
  respondedAt   DateTime? @map("responded_at")
  respondedById String?   @map("responded_by_id")

  // Visibility
  isPublic   Boolean @default(true) @map("is_public")
  isVerified Boolean @default(true) @map("is_verified") // Verified customer

  // Source
  source ReviewSource @default(PORTAL)

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@index([customerId])
  @@index([overallRating])
  @@map("customer_reviews")
  @@schema("fixitbh_ac")
}

enum ReviewSource {
  PORTAL // Customer portal
  EMAIL_LINK // Email follow-up link
  SMS_LINK // SMS follow-up link
  MANUAL // Entered by staff
  GOOGLE // Imported from Google
  SOCIAL // Social media

  @@schema("fixitbh_ac")
}

// ==================== MEMBERSHIP/SUBSCRIPTION ====================

model MembershipPlan {
  id            String  @id @default(cuid())
  name          String
  nameAr        String? @map("name_ar")
  code          String  @unique // e.g., "BASIC", "PREMIUM", "GOLD"
  description   String?
  descriptionAr String? @map("description_ar")

  // Pricing
  price        Decimal      @db.Decimal(10, 3)
  billingCycle BillingCycle @map("billing_cycle")

  // Features
  features Json? // Array of features included

  // Discounts
  serviceDiscount   Decimal @default(0) @map("service_discount") @db.Decimal(5, 2) // % off services
  partsDiscount     Decimal @default(0) @map("parts_discount") @db.Decimal(5, 2) // % off parts
  priorityService   Boolean @default(false) @map("priority_service")
  freeVisitsPerYear Int     @default(0) @map("free_visits_per_year")

  // Settings
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  // Relations
  subscriptions CustomerMembership[]

  @@map("membership_plans")
  @@schema("fixitbh_ac")
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL

  @@schema("fixitbh_ac")
}

model CustomerMembership {
  id         String         @id @default(cuid())
  customerId String         @map("customer_id")
  customer   Customer       @relation(fields: [customerId], references: [id])
  planId     String         @map("plan_id")
  plan       MembershipPlan @relation(fields: [planId], references: [id])

  // Subscription period
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // Status
  status MembershipStatus @default(ACTIVE)

  // Billing
  lastBilledAt  DateTime? @map("last_billed_at")
  nextBillingAt DateTime? @map("next_billing_at")

  // Auto-renewal
  autoRenew Boolean @default(true) @map("auto_renew")

  // Payment method
  paymentMethod String? @map("payment_method")

  // Usage tracking
  freeVisitsUsed Int @default(0) @map("free_visits_used")

  // Cancellation
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason")

  createdAt   DateTime @default(now()) @map("audit_create_date")
  createdById String?  @map("audit_create_by")
  updatedAt   DateTime @updatedAt @map("audit_change_date")
  updatedById String?  @map("audit_change_by")

  @@index([customerId])
  @@index([status])
  @@map("customer_memberships")
  @@schema("fixitbh_ac")
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
  PENDING_PAYMENT

  @@schema("fixitbh_ac")
}
